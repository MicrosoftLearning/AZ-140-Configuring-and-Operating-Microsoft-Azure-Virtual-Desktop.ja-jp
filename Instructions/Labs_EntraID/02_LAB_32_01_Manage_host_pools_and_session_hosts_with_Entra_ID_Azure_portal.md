---
lab:
  title: 'ラボ: Azure portal を使用してホスト プールとセッション ホストを管理する (Entra ID)'
  module: 'Module 3.2: Plan and implement user experience and client settings'
---

# ラボ - Azure portal を使用してホスト プールとセッション ホストを管理する (Entra ID)
# 受講生用ラボ マニュアル

## ラボの依存関係

- このラボで使用する Azure サブスクリプション。
- このラボで使用する Azure サブスクリプションの所有者または投稿者ロールを持ち、その Azure サブスクリプションに関連付けられた Entra テナントにデバイスを参加させるのに十分なアクセス許可を持つ Microsoft Entra ユーザー アカウント。
- ラボ *Azure portal を使用してホスト プールとセッション ホストをデプロイする (Entra ID)* 完了

## 推定所要時間

30 分

## ラボのシナリオ

Azure Virtual Desktop 環境が既にあります。 さまざまな機能要件とビジネス要件をサポートするには、Microsoft Entra 参加済みセッション ホストでホスト プールを構成する必要があります。 これらの要件の内容は次のとおりです。

- リモート ユーザーの増加に対応するために追加のセッション ホストをデプロイする
- ホスト プールの負荷分散構成を最適化し、*Start VM on Connect* 機能を活用することで、Azure Virtual Desktop 環境のコストを最小限に抑える
- メンテナンス ウィンドウを実装して、営業時間中のセッション ホストの可用性を最大化する
- Microsoft Entra 参加済みセッション ホストへのシングル サインオンを有効にする
- 使いやすさとユーザー エクスペリエンスを最大化する (切断されたセッションの自動再接続など)

## 目標
  
このラボを完了すると、次のことができるようになります。

- Microsoft Entra 参加済み Azure Virtual Desktop セッション ホストを構成して、さまざまな機能要件とビジネス要件をサポートする

## ラボ ファイル

- なし

## 手順

### 演習 1: Microsoft Entra 参加済みセッション ホストを含む Azure Virtual Desktop 環境を管理する
  
この演習の主なタスクは次のとおりです。

1. 追加の Azure Virtual Desktop ホスト プール セッション ホストをデプロイする
1. ホスト プールのプロパティを確認および構成する
1. Azure Virtual Desktop サービス プリンシパルに必要な RBAC ロールを割り当てる
1. スケジュール化されたエージェントの更新を構成する
1. ホスト プールの RDP プロパティを構成する

#### タスク 1: 追加の Azure Virtual Desktop ホスト プール セッション ホストをデプロイする

1. 必要に応じて、ラボ コンピューターから Web ブラウザーを起動して Azure portal に移動し、このラボで使用するサブスクリプションの所有者ロールを持つユーザー アカウントの資格情報を入力してサインインします。

    > **注**: ラボ セッション ウィンドウの右側にある [リソース] タブに表示されている `User1-` アカウントの資格情報を使用します。

1. Azure portal が表示されている Web ブラウザーで、**Azure Virtual Desktop** を検索して選択し、**[Azure Virtual Desktop]** ページの垂直メニュー バーの **[管理]** セクションで、**[ホスト プール]** を選択します。
1. **[Azure Virtual Desktop \| ホスト プール]** ページで、ホスト プールの一覧から **[az140-21-hp1]** を選択します。
1. **[az140-21-hp1]** ページの垂直メニューバーの **[管理]** セクションで、**[セッション ホスト]** を選択し、プールが 2 つのホストで構成されていることを確認します。 
1. **[az140-21-hp1 \| セッション ホスト]** ページで、**[+ 追加]** を選択します。
1. **[Virtual Machines をホスト プールに追加]** ページの **[基本]** タブで、事前構成された設定を確認し、**[次へ: Virtual Machines]** を選択します。
1. **[Virtual Machines をホスト プールに追加]** ページの **[Virtual Machines]** タブで、次の設定を指定し、**[確認および作成]** を選択します (他は既定値のままにします)。

    > **注**: **名前のプレフィックス**値を設定するときは、ラボ セッション ウィンドウの右側にある [リソース] タブに切り替え、*User1-* と *@* 文字の間の文字の文字列を識別します。 この文字列を使用して、*ランダム* プレースホルダーを置き換えます。

    |設定|値|
    |---|---|
    |リソース グループ|**az140-21e-RG**|
    |名前のプレフィックス|**sh**-*random*|
    |仮想マシンの場所|最初の 2 つのセッション ホスト VM をデプロイした Azure リージョンの名前|
    |可用性のオプション|**インフラストラクチャ冗長は必要ありません**|
    |セキュリティの種類|**トラステッド起動の仮想マシン**|
    |Image|**Windows 11 Enterprise マルチセッション、バージョン 23H2 + Microsoft 365 Apps**|
    |仮想マシンのサイズ|**Standard DC2s_v3**|
    |[Number of VMs](VM の数)|**1**|
    |OS ディスクの種類|**Standard SSD**|
    |OS ディスク サイズ|**既定のサイズ (128 GB)**|
    |ブート診断|**マネージド ストレージ アカウントで有効にする (推奨)**|
    |仮想ネットワーク|**az140-vnet11e**|
    |Subnet|**hp1-Subnet**|
    |ネットワーク セキュリティ グループ|**Basic**|
    |パブリック インバウンド ポート|**いいえ**|
    |参加したいディレクトリを選択する|**Microsoft Entra ID**|
    |Intune に VM を登録する|**いいえ**|
    |ユーザー名|**Student**|
    |Password|ラボ *Azure portal を使用してホスト プールとセッション ホストをデプロイする (Entra ID)* でセッション ホストをデプロイする際に使用したパスワードと同じもの 
    |[パスワードの確認入力]|前に指定したパスワードと同じもの|

    > **注**: パスワードの長さは 12 文字以上で、小文字、大文字、数字、特殊文字の組み合わせで構成されている必要があります。 詳細については、[Azure VM の作成時のパスワード要件](https://learn.microsoft.com/en-us/azure/virtual-machines/windows/faq#what-are-the-password-requirements-when-creating-a-vm-)に関する情報をご覧ください。

    > **注**: このように、既存のプールにセッション ホストを追加するときに、VM のイメージとプレフィックスを変更できます。 一般に、プール内のすべての VM を置き換える予定がない限り、これは推奨されません。 

1. **[仮想マシンをホスト プールに追加]** ページの **[確認および作成]** タブで、**[作成]** を選択します

    > **注**:プロビジョニング プロセスが完了するのを待たずに、次のタスクに進んでください。 プロビジョニング プロセスには約 20 分かかる場合があります。 

#### タスク 2: ホスト プールのプロパティを確認および構成する

1. ラボ コンピューターの Azure portal が表示されている Web ブラウザーで、**Azure Virtual Desktop** を検索して選択し、**[Azure Virtual Desktop]** ページの縦型ナビゲーション メニューの **[管理]** セクションで、**[ホスト プール]** を選択し、**[Azure Virtual Desktop \| ホスト プール]** ページで **az140-21-hp1** を選択します。 
1. **[az140-21-hp1]** ページの **[設定]** セクションで、**[プロパティ]** を選択します。
1. **[az140-21-hp1\|プロパティ]** ページで、次のような使用可能な構成オプションを確認します。

    - **優先するアプリ グループの種類**: このオプションは、ホスト プールの優先アプリ グループの種類を**デスクトップ**か **RemoteApp** のどちらかに設定します。 ホスト プールで RemoteApp アプリとデスクトップ アプリの両方がエンド ユーザーに公開されている場合、選択したアプリの種類のみフィードに表示されます。
    - **接続時に VM を起動する**: このオプションを有効にすると、ユーザーはホスト プール内の個々の仮想マシンを割り当て解除状態から起動できます。
    - **検証環境**: 検証ホスト プールは、運用環境にデプロイされる前にサービスの変更をテストすることを目的としています。
    - **負荷分散アルゴリズム**: このオプションでは、幅優先の負荷分散と深さ優先の負荷分散のどちらかを選択できます。 幅優先の負荷分散では、新しいユーザー セッションがホスト プール内のすべての使用可能なセッション ホストに分散されます。 深さ優先の負荷分散では、接続数が最も多くてもそのセッションの上限しきい値に達していない利用可能なセッション ホストに新しいユーザー セッションが分散されます。

1. **[az140-21-hp1 \| プロパティ]** ページの **[負荷分散アルゴリズム]** ドロップダウン リストで、**[深さ優先]** を選択します。
1. **[最大セッションの制限]** テキスト ボックスに「**8**」と入力します。
1. **[az140-21-hp1 \| プロパティ]** ページで、**Start VM on Connect** を **[はい]** に設定します。

    > **注**: *Start VM on Connect* を使用すると、エンド ユーザーが必要な場合にのみセッション ホストとして使用される仮想マシン (VM) の電源をオンにできるため、コストを削減できます。 個人用ホスト プールの場合、*Start VM on Connect* では、ユーザーに既に割り当てられているか割り当てが可能な既存のセッション ホスト VM でのみ電源がオンになります。 プールされたホスト プールの場合、*Start VM on Connect* は、電源がオンになっているセッション ホスト VM がない場合にのみオンにします。追加の VM は、最初の VM がセッション制限に達した場合にのみオンになります。

1. **[az140-21-hp1 \| プロパティ]** ページで、**[保存]** を選択します。

    > **注**: *Start VM on Connect* を使用するには、Azure サブスクリプション スコープで、*Desktop Virtualization Power On 共同作成者*のロールベースのアクセス制御 (RBAC) ロールを *Azure Virtual Desktop* サービス プリンシパルに割り当てる必要があります。 

#### タスク 3: Azure Virtual Desktop サービス プリンシパルに必要な RBAC ロールを割り当てる

1. ラボ コンピューターの Azure portal が表示されている Web ブラウザーで、Azure Cloud Shell の PowerShell セッションを開始します。

    > **注**: メッセージが表示されたら、**[概要]** ペインの **[サブスクリプション]** ドロップダウン リストで、このラボで使用している Azure サブスクリプションの名前を選択し、**[適用する]** を選択します。

1. Azure Cloud Shell ペインの PowerShell セッションで、次のコマンドを実行して、このラボで使用している Azure サブスクリプションの ID プロパティの値を取得し、変数 `$subId` に格納します。

    ```powershell
    $subId = (Get-AzSubscription).Id
    ```

1. 次のコマンドを実行して、$parameters 変数を作成します。この変数には、RBAC ロール定義名、**Azure Virtual Desktop** サービス プリンシパルとサブスクリプション スコープを表す Microsoft Entra アプリケーションの値を含むハッシュ テーブルが格納されます。

    ```powershell
    $parameters = @{
        RoleDefinitionName = "Desktop Virtualization Power On Contributor"
        ApplicationId = "9cdead84-a844-4324-93f2-b2e6bb768d07"
        Scope = "/subscriptions/$subId"
    }
    ```

1. RBAC ロールの割り当てを作成するには、次のコマンドを実行します。

    ```powershell
    New-AzRoleAssignment @parameters
    ```

1. [Cloud Shell] ペインを閉じます。

#### タスク 4: スケジュール化されたエージェントの更新を構成する

> **注**: スケジュール化されたエージェントの更新機能を使用すると、Azure Virtual Desktop エージェント、サイドバイサイド スタック、Geneva Monitoring エージェント用に最大 2 つのメンテナンス ウィンドウを作成して、営業時間外に更新が行われるようにすることができます。 

1. Azure portal が表示されている Web ブラウザーで、**[az140-21-hp1]** ホスト プール ページに移動します。
1. **[az140-21-hp1]** ページの垂直メニュー バーの **[設定]** セクションで、**スケジュール化されたエージェントの更新**エントリを選択し、**[az140-21-hp1 \| スケジュール化されたエージェントの更新]** ページで、**[スケジュール化されたエージェントの更新]** チェックボックスをオンにします。
1. **[スケジュール]** セクションで、**[ローカル セッション ホスト タイム ゾーンを使用する]** チェックボックスをオンにします。
1. **[メンテナンス ウィンドウ]** セクションの **[日]** ドロップダウン リストで、**[土曜日]** を選択し、**[時間]** ドロップダウン リストで、**[11:00 PM]** を選択します。
1. **適用**を選択します。

#### タスク 5: ホスト プールの RDP プロパティを構成する

1. Azure portal が表示されている Web ブラウザーの **[az140-21-hp1]** ページの垂直メニュー バーの **[設定]** セクションで、**[RDP プロパティ]** エントリを選択します。
1. **[az140-21-hp1 \| RDP プロパティ]** ページの **[接続情報]** タブで、次のような使用可能な構成オプションを確認します。

    - **Microsoft Entra シングル サインオン**: このオプションは、接続が Microsoft Entra 認証を活用して Microsoft Entra 参加済みセッション ホストにサインインし、効果的にシングル サインオン エクスペリエンスを提供するかどうかを決定します。 クライアント コンピューターを Microsoft Entra に参加させる必要はありません。 
    - **資格情報セキュリティ サポート プロバイダー**: このオプションは認証に CredSSP を使用するのを管理します。 CredSSP は、クライアント デバイスからリモート デスクトップ セッション ホストにユーザー資格情報を安全に転送する機能を提供します。 ただし、その機能には Entra ID 認証のサポートは含まれていません。
    - **代替シェル**: このオプションを使用すると、セッション ホストへの新しい接続が確立されるたびに起動する実行可能ファイルを指定できます。 この設定は、Windows Server を実行しているセッション ホストにのみ適用されます。
    - **KDC プロキシ名**: このオプションは、Kerberos 認証トラフィックを Active Directory ドメイン コントローラーにプロキシする機能を提供します。

    > **注**: これらのオプションのうち 3 つは、このシナリオでは適用できない (Active Directory Domain Services が存在しない Microsft Entra 参加済みセッション ホストを含む) ことを考慮して、最初のオプションのみを構成します。 このオプションは、`enablerdsaadauth:i:value` RDP プロパティに対応します。

1. **[Microsoft Entra のシングル サインオン]** ドロップダウン リストで、**[シングル サインオンを提供するために接続が Microsoft Entra 認証を使用する]** オプションを選択してから、**[保存]** を選択します。

    > **重要**: この特定の RDP プロパティを有効にすることは、シングル サインオン機能を実装するために必要ないくつかの手順の 1 つに過ぎないことに注意が必要です。 このシナリオに適用できるその他のアクションには、Entra テナントでの RDP に対する Microsoft Entra 認証の有効化や、現在のバージョンのラボ環境ではサポートされていないデバイス グループの構成が含まれます。そのため、手順には含まれません。 Microsoft Entra ID のシングル サインオンを実装するために必要なアクションの完全な一覧については、「[Microsoft Entra ID 認証を使用して Azure Virtual Desktop に対するシングル サインオンを構成する](https://learn.microsoft.com/en-us/azure/virtual-desktop/configure-single-sign-on)」をご覧ください。

1. **[az140-21-hp1 \| RDP プロパティ]** ページで、**[セッションの動作]** タブを選択し、次のような使用可能な構成オプションを確認します。

    - **再接続**: このオプションは、接続が削除された場合に、クライアント コンピューターがリモート コンピューターへの再接続を自動的に試みるかどうかを決定します。
    - **帯域幅の自動検出**: このオプションは、ネットワーク帯域幅の自動検出を使用するかどうかを決定します。
    - **ネットワークの自動検出**: このオプションを使用すると、ネットワークの種類の自動検出を有効にすることができます。 これは、**[帯域幅の自動検出]** と組み合わせて使用します。 
    - **圧縮**: このオプションは、接続で一括圧縮を使用するかどうかを決定します。
    - **ビデオ再生**: このオプションを使用すると、ビデオ再生に RDP 有効マルチメディア ストリーミングを使用できます。

1. **[セッションの動作]** タブの **[再接続]** ドロップダウン リストで、**[クライアントが自動的に再接続を試みる]** を選択してから、**[保存]** を選択します。
1. **az140-21-hp1 \| RDP プロパティ** ページで、**Device リダイレクト** タブを選択し、2 つの主要なカテゴリを含む使用可能な構成オプションを確認します。

    - **オーディオとビデオ**
    - **ローカル デバイスとリソース**

    > **注**: 既定では、初期接続が確立された後にマウントされるディスク ドライブを含め、すべてのディスク ドライブにリダイレクトが適用されます。

1. **[az140-21-hp1 \| RDP プロパティ]** ページで、**[ディスプレイの設定]** タブを選択し、複数のディスプレイ、スマート サイズ設定、特定のデスクトップ サイズ (ピクセル単位) のサポートなど、使用可能な構成オプションを確認します。 
1. **[az140-21-hp1 \| RDP プロパティ]** ページで、**[詳細]** タブを選択し、既存の構成設定を確認します。 これらの設定には、このタスクで前に加えた変更が反映されていることに注意してください。