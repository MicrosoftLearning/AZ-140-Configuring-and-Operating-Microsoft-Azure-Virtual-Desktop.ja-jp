---
lab:
  title: 'ラボ: セッション ホストの自動スケーリングを実装する'
  module: 'Module 4.1: Monitor and manage Azure Virtual Desktop services'
---

# ラボ - セッション ホストの自動スケーリングを実装し、監視する
# 受講生用ラボ マニュアル

## ラボの依存関係

- このラボで使用する Azure サブスクリプション。
- このラボで使用する Azure サブスクリプションの所有者または投稿者ロールを持ち、その Azure サブスクリプションに関連付けられた Entra テナントにデバイスを参加させるのに十分なアクセス許可を持つ Microsoft Entra ユーザー アカウント。
- ラボ *Azure portal を使用してホスト プールとセッション ホストをデプロイする (Entra ID)* 完了
- ラボ *Azure portal を使用してホスト プールとセッション ホストを管理する (Entra ID)* 完了
- ラボ *セッション ホストに接続する (Entra ID)* 完了

## 推定所要時間

45 分

## ラボのシナリオ

使用量が定期的に変更される Azure Virtual Desktop 環境があります。 自動スケーリング プランの機能を利用して、コストを最小限に抑えたいと考えています。

## 目標
  
このラボを完了すると、次のことができるようになります。

- Azure Virtual Desktop の自動スケーリングを実装して評価する

## ラボ ファイル

- なし

## 手順

### 演習 1: Azure Virtual Desktop の自動スケーリング プランを実装する
  
この演習の主なタスクは次のとおりです。

1. Azure Virtual Desktop サービス プリンシパルに必要な RBAC ロールを割り当てる
1. すべてのセッション ホストを停止して割り当てを解除する
1. ホスト プールの設定を調整する
1. スケーリング プランを作成する
1. 自動スケーリング機能を評価する
1. ホスト プールの自動スケーリングを無効にする

#### タスク 1: Azure Virtual Desktop サービス プリンシパルに必要な RBAC ロールを割り当てる

> **注**: 自動スケーリング プランを機能させるには、セッション ホスト VM の電源状態を管理するためのアクセス許可を Azure Virtual Desktop サービス プリンシパルに付与する必要があります。 これらのアクセス許可は、組み込みの **Desktop Virtualization Power On 共同作成者** RBAC ロールを使用して付与できます。 ロールの割り当てはサブスクリプション スコープで実行する必要があることに注意してください。 この ロールを、リソース グループ、ホスト プール、VM など、ご利用のサブスクリプションより低いレベルで割り当てると、自動スケーリング機能が正しく動作しなくなります。 

> **注**: このロールは、ラボ *Azure portal を使用してホスト プールとセッション ホストを管理する (Entra ID)* で使用したロール (**Desktop Virtualization Power On 共同作成者**) とは異なります。これは、*Start VM on Connect* 機能をサポートするために必要でした。

1. 必要に応じて、ラボ コンピューターから Web ブラウザーを起動して Azure portal に移動し、このラボで使用するサブスクリプションの所有者ロールを持つユーザー アカウントの資格情報を入力してサインインします。

    > **注**: ラボ セッション ウィンドウの右側にある [リソース] タブに表示されている `User1-` アカウントの資格情報を使用します。

1. ラボ コンピューターの Azure portal が表示されている Web ブラウザーで、Azure Cloud Shell の PowerShell セッションを開始します。

    > **注**: メッセージが表示されたら、**[概要]** ペインの **[サブスクリプション]** ドロップダウン リストで、このラボで使用している Azure サブスクリプションの名前を選択し、**[適用する]** を選択します。

1. Azure Cloud Shell ペインの PowerShell セッションで、次のコマンドを実行して、このラボで使用している Azure サブスクリプションの ID プロパティの値を取得し、変数 `$subId` に格納します。

    ```powershell
    $subId = (Get-AzSubscription).Id
    ```

1. 次のコマンドを実行して、$parameters 変数を作成します。この変数には、RBAC ロール定義名、**Azure Virtual Desktop** サービス プリンシパルとサブスクリプション スコープを表す Microsoft Entra アプリケーションの値を含むハッシュ テーブルが格納されます。

    ```powershell
    $parameters = @{
        RoleDefinitionName = "Desktop Virtualization Power On Off Contributor"
        ApplicationId = "9cdead84-a844-4324-93f2-b2e6bb768d07"
        Scope = "/subscriptions/$subId"
    }
    ```

1. RBAC ロールの割り当てを作成するには、次のコマンドを実行します。

    ```powershell
    New-AzRoleAssignment @parameters
    ```

1. [Cloud Shell] ペインを閉じます。

#### タスク 2: すべてのセッション ホストを停止して割り当てを解除する

> **注**: 自動スケーリング機能を評価するには、Azure Virtual Desktop 環境のすべてのセッション ホストを停止して割り当てを解除します。 

1. ラボ コンピューターから Azure portal が表示されている Web ブラウザーで、**[Azure Virtual Desktop]** を検索して選択し、**[Azure Virtual Desktop]** ページにある垂直メニュー バーで、**[管理]** セクションの **[ホスト プール]** を選択します。
1. **[Azure Virtual Desktop \| ホスト プール]** ページで、ホスト プールの一覧から **[az140-21-hp1]** を選択します。
1. **[az140-21-hp1]** ページの垂直メニュー バーの **[管理]** セクションで、**[セッション ホスト]** を選択します。
1. **[az140-21-hp1 \| セッション ホスト]** ページで、各セッション ホスト名の横にあるチェック ボックスをオンにし、**[停止]** を選択します。
1. 確認を求められたら、**[セッション ホストを停止]** ポップアップ ウィンドウで **[停止]** を選択します。

    > **注**: **[停止]** ボタンを表示するには、ツール バーの省略記号 (`...`) アイコンを選択する必要がある場合があります。

    > **注**: セッション ホストが停止して割り当てが解除されるまで待たずに、次のタスクに進んでください。 セッション ホストの停止と割り当ての解除には、約 2 分かかる場合があります。

#### タスク 3: ホスト プールの設定を調整する

> **注**: プールされたホスト プールで自動スケーリングを使用する場合は、そのホスト プールに MaxSessionLimit パラメーターが構成されている必要があります。 このラボでは、自動スケーリング機能の説明を容易にするために、人為的に低く設定します。

1. ラボ コンピューターから Azure portal が表示されている Web ブラウザーで、**[az140-21-hp1]** ページにある **[設定]** セクションで **[プロパティ]** を選択します。
1. **[az140-21-hp1 \| プロパティ]** ページの **[最大セッションの制限]** テキスト ボックスに「**1**」と入力します。
1. **[az140-21-hp1 \| プロパティ]** ページで、**[保存]** を選択します。

#### タスク 4: スケーリング プランを作成する

1. ラボ コンピューターから Azure portal が表示されている Web ブラウザーで **[Azure Virtual Desktop]** を検索して選択し、**[Azure Virtual Desktop]** ページにある垂直ナビゲーション メニューで、**[管理]** セクションの **[スケーリング プラン]** を選択します。
1. **[Azure Virtual Desktop \| スケーリング プラン]** ページで、**[+ 作成]** を選択します。
1. **[スケーリング プランの作成]** ページの **[基本]** タブで、以下の設定を指定し、**[次へ: スケジュール]** を選択します。

    |設定|値|
    |---|---|
    |サブスクリプション|このラボで使用している Azure サブスクリプションの名前|
    |リソース グループ|新しいリソース グループ **az140-412e-RG** の名前|
    |スケーリング プラン名|**az140-scalingplan412e**|
    |リージョン|Azure Virtual Desktop 環境をデプロイした Azure リージョンの名前|
    |フレンドリ名|**az140-scalingplan412e**|
    |タイム ゾーン|Azure Virtual Desktop 環境をデプロイした Azure リージョンのローカル タイム ゾーン|
    |ホスト プールの種類|**プールされた**|
    |スケーリング方法|**電源管理の自動スケーリング**|

    > **注**: **[除外タグ]** プロパティは設定されないままにします。 一般に、この機能を使用して、タグを任意に設定した Azure VM を自動スケールから除外できます。

1. **[スケジュール]** タブで **[+ スケジュールの追加]** を選択します。

    > **注**: スケジュールを使用すると、稼働日のランプアップ時間、ピーク時間、ランプダウン時間、オフピーク時間を定義し、自動スケーリング トリガーを指定できます。 スケーリング プランには、その週の少なくとも 1 日に関連付けられたスケジュールを含める必要があります。 

1. **[スケジュールの追加]** ペインの **[全般]** タブで、次の設定と一致するように既定の構成を調整し、**[次へ]** を選択します。

    |設定|Value|
    |---|---|
    |タイム ゾーン|Azure Virtual Desktop 環境のローカル タイム ゾーン (このタスクで先ほど選択したリージョンに基づく)|
    |スケジュール名|**week_schedule**|
    |繰り返し|**7 を選択** (すべての曜日を選択)|

    > **注**: スケジュールは毎日効果的にカバーされるため、自動スケーリングの結果の評価が容易になります。

1. **[スケジュールの追加]** ペインの **[ランプアップ]** タブで、次の設定と一致するように既定の構成を調整し、**[次へ]** を選択します。

    |設定|Value|
    |---|---|
    |開始時刻 (12 時間システム)|現在の時刻から 1 時間を引いた時刻|
    |負荷分散アルゴリズム|**幅優先**|
    |ホストの最小割合 (%)|**30**|
    |容量のしきい値 (%)|**60**|

    > **注**: プールされたホスト プールの場合、自動スケーリングでは、ホスト プールの設定における既存の負荷分散アルゴリズムは無視され、代わりにスケジュール構成に基づいた負荷分散が適用されます。

    > **注**: **[ホストの最小割合]** の設定には、ランプアップ時間とピーク時間に起動するセッション ホスト仮想マシンの最小割合を指定します。 たとえば、**[ホストの最小割合]** が 30% として指定され、ホスト プール内のセッション ホストの合計数が 3 の場合、自動スケーリングにより、少なくとも 1 つのセッション ホストがユーザー接続を受け入れることができるようになります。

    > **注**: 自動スケーリングでは、最も近い整数に切り上げられます。

    > **注**: **[容量のしきい値]** の設定は、ランプアップ時間とピーク時間に仮想マシンをオンまたはオフにするかどうかを評価するために考慮される、使用済みホスト プール容量の割合です。 たとえば、容量のしきい値が 60% として指定され、ホスト プールの合計容量が 1 セッション (実行中のホストは 1 つ) の場合、ホスト プールの負荷が 60% (この場合は 100%) を超えると、自動スケーリングによって追加のセッション ホストがオンになります。

1. **[スケジュールの追加]** ペインの **[ピーク時間]** タブで、次の設定に一致するように既定の構成を調整し、**[次へ]** を選択します。

    |設定|Value|
    |---|---|
    |開始時刻 (12 時間システム)|現在の時刻に 1 時間を足した時刻|
    |負荷分散アルゴリズム|**深さ優先**|
    |容量のしきい値 (%)|**60**|

    > **注**: **[容量のしきい値 (%)]** の設定は、**[ランプアップ]** および **[ピーク時間]** の設定の間で共有されます。

1. **[スケジュールの追加]** ペインの **[ランプダウン]** タブで、次の設定と一致するように既定の構成を調整し、**[次へ]** を選択します。

    |設定|Value|
    |---|---|
    |開始時刻 (12 時間システム)|現在の時刻に 2 時間を足した時刻|
    |負荷分散アルゴリズム|**深さ優先**|
    |アクティブ ホストの最小割合 (%)|"**10**"|
    |容量のしきい値 (%)|**80**|
    |Force logoff users(ユーザーの強制ログオフ)|**いいえ**|
    |VM を停止する場合|**VM にアクティブなセッションまたは切断されたセッションがない**|

    > **注**: **[アクティブ ホストの最小割合 (%)]** の設定には、ランプダウン時間とオフピーク時間に取得するセッション ホスト仮想マシンの最小割合を指定します。 たとえば、**[アクティブ ホストの最小割合 (%)]** が 10% に設定され、ホスト プール内のセッション ホストの合計数が 3 の場合、自動スケーリングにより、少なくとも 1 つのセッション ホストがユーザー接続を受け入れることができるようになります。

    > **注**: **[容量のしきい値 (%)]** の設定には、ランプダウン時間とオフピーク時間に仮想マシンをオフにするかどうかを評価するために考慮される、使用済みホスト プール容量の割合を指定します。 たとえば、1 人のユーザー接続と 3 つのホストが実行され、容量のしきい値が 80% として指定されている場合、自動スケーリングによって 1 つのホストがオフになります (その結果、使用済みホスト プールの容量は 50% になります)。

    > **注**: 一般に、自動スケーリングでは、次の規則に従ってセッション ホストが停止され、割り当てが解除されます。

    - 使用済みホスト プール容量が容量しきい値を下回る。
    - セッション ホストをオフにしても、容量のしきい値を超えるわけではありません。
    - 自動スケーリングでは、スケーリング プランがランプダウン フェーズ中で、ユーザーの強制ログオフの設定を有効にしている場合を除き、ユーザー セッションがないセッション ホストのみをオフにします。 
    - プールされた自動スケーリングでは、ユーザー エクスペリエンスが影響を受けないように、ランプアップ フェーズでセッション ホストがオフになりません。

1. **[スケジュールの追加]** ペインの **[オフピーク時間]** タブで、次の設定に一致するように既定の構成を調整し、**[追加]** を選択します。

    |設定|Value|
    |---|---|
    |開始時刻 (12 時間システム)|現在の時刻に 3 時間を足した時刻|
    |負荷分散アルゴリズム|**深さ優先**|
    |容量のしきい値 (%)|**80**|

    > **注**: **[容量のしきい値]** の設定は、**[ランプダウン]** および **[オフピーク時間]** の設定の間で共有されます。

1. **[スケーリング プランの作成]** ページの **[スケジュール]** タブに戻り、**[次へ: ホスト プールの割り当て]** を選択します。
1. **[ホスト プールの割り当て]** タブの **[ホスト プールの選択]** ドロップダウン リストで **[az140-21-hp1]** を選択し、**[自動スケーリングの有効化]** チェックボックスがオンになっていることを確認し、**[確認および作成]** を選択します。
1. **[確認および作成]** ページで、 **[作成]** を選択します。

    > **注**: 自動スケーリングの構成が完了するまで待ちます。 通常、これには数秒しかかかりません。

#### タスク 5: 自動スケーリング機能を評価する

> **注**: まず **[ランプアップ]** の設定を評価します。

1. ラボ コンピューターから Azure portal が表示されている Web ブラウザーで、**[Azure Virtual Desktop]** を検索して選択し、**[Azure Virtual Desktop]** ページにある垂直メニュー バーで、**[管理]** セクションの **[ホスト プール]** を選択します。
1. **[Azure Virtual Desktop \| ホスト プール]** ページで、ホスト プールの一覧から **[az140-21-hp1]** を選択します。
1. **[az140-21-hp1]** ページの垂直メニュー バーの **[管理]** セクションで、**[セッション ホスト]** を選択します。
1. **[az140-21-hp1 \| セッション ホスト]** ページで、セッション ホストの **[電源状態]** の設定の値を確認し、そのうち 1 つのセッションホストが **[実行中]** として表示されていることを確認します。

    > **注**: 最初のセッション ホストが **[実行中]** 状態になるまで、数分待つ必要がある場合があります。

    > **注**: これは、新しく作成されたスケーリング プランの **[ランプアップ]** の設定に従って、少なくとも 1 つのセッション ホストが常にオンラインになっている必要があるためです。 この時点で、ホスト プールの容量は 1 です (実行中のホストが 1 つしかないため)。ただし、ユーザー接続がないため、使用済みホスト プールの容量は 0% です。

    > **注**: 次に、単一のユーザー セッションを開始して、**[ランプアップ]** と **[ピーク時間]** の容量しきい値の設定を評価します。 これは、2 つのステージが同じ容量しきい値を 共有するため、**ピーク時間**外でも評価できます。

1. ラボ コンピューターから、Microsoft リモート デスクトップ クライアントを起動します。
1. ラボ コンピューターの **[リモート デスクトップ]** クライアント ウィンドウで、**[登録]** を選択し、メッセージが表示されたら、ラボ インターフェイス ウィンドウの右側のペインにある **[リソース]** タブで検索できる `User2` Entra ID ユーザー アカウントの資格情報でサインインします。
1. **[リモート デスクトップ]** ページに、Microsoft Word、Microsoft Excel、Microsoft PowerPoint、コマンド プロンプトなどの 4 つのアイコンが表示されていることを確認します。 
1. [コマンド プロンプト] アイコンをダブルクリックします。 
1. サインインを求められたら、**[Windows セキュリティ]** ダイアログ ボックスに、お使いの Azure Virtual Desktop 環境への接続に使用した Microsoft Entra ユーザー アカウントのパスワードを入力します。
1. 直後に **[コマンド プロンプト]** ウィンドウが表示されることを確認します。 

    > **注**: この時点で、使用済みホスト プール容量が 100% になり、容量しきい値 (60%) を超えます。 これにより、別のホストで自動スケーリングがオンになり、使用済みホスト プールの容量が 50% になります。 これは容量しきい値を下回っているため、3 番目のホストは停止/割り当て解除されたままになります。 これを次に確認します。

1. ラボ コンピューターから、Azure portal が表示されている Web ブラウザー ウィンドウに切り替えます。 
1. **[az140-21-hp1 \| セッション ホスト]** ページで、**[最新の情報に更新]** を選択し、セッション ホストの **[電源状態]** の設定の値を確認し、そのうち 2 つのセッションホストが **[実行中]** として表示されていることを確認します。

    > **注**: 次に、時間枠を調整して、**[ランプダウン]** の容量しきい値の設定を評価します。 

1. **[az140-21-hp1 \| セッション ホスト]** ページの垂直ナビゲーション メニューの **[設定]** セクションで、**[スケーリング プラン]** を選択し、**[スケーリング プラン]** ページで **[az140-scalingplan412e]** を選択します。
1. **[az140-scalingplan412e]** ページの垂直ナビゲーション メニューの **[設定]** セクションで、**[スケジュール]**、**[week_schedule]** の順に選択します。
1. **[week_schedule]** ペインで、**[ランプダウン]** タブに移動し、**開始時間 (12 時間システム) **設定の値を、**開始時刻 (12 時間システム)****時間**フェーズと現在の時刻の間の任意の時刻に調整します。

    > **注**: **[ピーク時間]** フェーズの **[開始時間 (12 時間システム)]** の値を調整する必要がある場合があります。

1. **[week_schedule]** ペインで、**[オフピーク時間]** タブに移動し、**[保存]** を選択します。
1. ホスト プールへの唯一の RDP セッションを表す **[コマンド プロンプト]** ウィンドウに切り替え、コマンド プロンプトで次のように入力し、**Enter** キーを押します。

    ```cmd
    logoff
    ```

1. ラボ コンピューターから Azure portal が表示されている Web ブラウザーで、**[Azure Virtual Desktop]** を検索して選択し、**[Azure Virtual Desktop]** ページにある垂直メニュー バーで、**[管理]** セクションの **[ホスト プール]** を選択します。
1. **[Azure Virtual Desktop \| ホスト プール]** ページで、ホスト プールの一覧から **[az140-21-hp1]** を選択します。
1. **[az140-21-hp1]** ページの垂直メニュー バーの **[管理]** セクションで、**[セッション ホスト]** を選択します。
1. **[az140-21-hp1 \| セッション ホスト]** ページで、セッション ホストの **[電源状態]** の設定の値を確認し、そのうち 1 つのセッションホストのみ **[実行中]** として表示されていることを確認します。

    > **注**: セッション ホストがシャットダウンされるまでに 1 分から 2 分かかる場合があります。

#### タスク 6: ホスト プールの自動スケーリングを無効にする

> **注**: 自動スケーリング構成が他のラボに影響を与えないようにするには、このラボで実装したスケーリング プランのホスト プールの割り当てを削除します。

1. ラボ コンピューターから Azure portal が表示されている Web ブラウザーで **[Azure Virtual Desktop]** を検索して選択し、**[Azure Virtual Desktop]** ページにある垂直ナビゲーション メニューの **[管理]** セクションで **[スケーリング プラン]** を選択し、**[スケーリング プラン]** ページで **[az140-scalingplan412e]** を選択します。
1. **[az140-scalingplan412e]** ページの **[管理]** セクションで、**[ホスト プールの割り当て]** を選択します。
1. **[az140-scalingplan412e\| ホスト プールの割り当て]** ページで、**az140-21-hp1** を選択したあと **[割り当て解除]** を選択し、**[ホスト プールの割り当て解除]** ダイアログ ボックスで確認を求められたら、**[割り当て解除]** を選択します。