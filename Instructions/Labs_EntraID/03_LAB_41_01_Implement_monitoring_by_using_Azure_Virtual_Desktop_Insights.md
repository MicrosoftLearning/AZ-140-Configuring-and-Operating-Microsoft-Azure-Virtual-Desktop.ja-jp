---
lab:
  title: 'ラボ: Azure Virtual Desktop の分析情報を使用して監視を実装する'
  module: 'Module 4.1: Monitor and manage Azure Virtual Desktop services'
---

# ラボ - Azure Virtual Desktop の分析情報を使用して監視を実装する
# 受講生用ラボ マニュアル

## ラボの依存関係

- このラボで使用する Azure サブスクリプション。
- このラボで使用する Azure サブスクリプションの所有者または投稿者ロールを持ち、その Azure サブスクリプションに関連付けられた Entra テナントにデバイスを参加させるのに十分なアクセス許可を持つ Microsoft Entra ユーザー アカウント。
- ラボ *Azure portal を使用してホスト プールとセッション ホストをデプロイする (Entra ID)* 完了
- ラボ *Azure portal を使用してホスト プールとセッション ホストを管理する (Entra ID)* 完了

## 推定所要時間

25 分

## ラボのシナリオ

Azure Virtual Desktop 環境が既にあります。 環境の状態とアクティビティを監視する必要があります。

## 目標
  
このラボを完了すると、次のことができるようになります。

- Azure Virtual Desktop 環境の監視を実装する

## ラボ ファイル

- なし

## 手順

### 演習 1: Azure Virtual Desktop 環境の監視を実装する
  
この演習の主なタスクは次のとおりです。

1. Microsoft.Insights リソース プロバイダーに Azure サブスクリプションを登録する
1. Azure Log Analytics ワークスペースを作成する
1. Virtual Desktop Insights 構成ブックを設定する

#### タスク 1: Microsoft.Insights リソース プロバイダーに Azure サブスクリプションを登録する

> **注**: Azure Virtual Desktop の分析情報は Microsoft.Insights リソース プロバイダーに依存しているため、このラボ用には、それを最初に使用中の Azure サブスクリプション内に登録する必要があります。 *Azure portal を使用してホスト プールとセッション ホストをデプロイする (Entra ID)* ラボでは、Azure PowerShell を使用してこのタスクを実行しました。 このラボでは、Azure portal を使用してこれを実行します (どちらの方法もサポートされ、使用可能です)。

1. 必要に応じて、ラボ コンピューターから Web ブラウザーを起動して Azure portal に移動し、このラボで使用するサブスクリプションの所有者ロールを持つユーザー アカウントの資格情報を入力してサインインします。

    > **注**: ラボ セッション ウィンドウの右側にある [リソース] タブに表示されている `User1-` アカウントの資格情報を使用します。

1. ラボ コンピューターの Azure portal が表示されている Web ブラウザーで、**サブスクリプション**を検索して選択し、**[サブスクリプション]** ページで、このラボで使用している Azure サブスクリプションを選択し、垂直ナビゲーション メニューの **[設定]** セクションで、**[リソース プロバイダー]** を選択します。
1. **[リソース プロバイダー]** タブの検索テキスト ボックスに、「**Microsoft.Insights**」と入力し、結果の一覧で、**Microsoft.Insights** エントリの左側にある小さな円を選択してから、**[登録]** を選択します。

    > **注**: 登録プロセスが完了するまで待ちます。 通常、これには 1 分ほどかかります。 ツール バーの **[更新]** ボタンを使用して、登録状態の最新の値を表示します。

#### タスク 2: Azure Log Analytics ワークスペースを作成する

> **注**: Azure Virtual Desktop の分析情報は、Azure Monitor Workbooks 上に構築されたダッシュボードで、Azure Virtual Desktop 環境を監視するのに役立ちます。 

> **注**: 自動スケーリング操作は、プールされたホスト プールを持つ分析情報でのみ監視できます。 

1. ラボ コンピューターの Azure portal が表示されている Web ブラウザーで、**Log Analytics ワークスペース**を検索して選択し、**[Log Analytics ワークスペース]** ページで、**[+ 作成]** を選択します。
1. **[Log Analytics ワークスペースの作成]** ページの **[基本]** タブで、次の設定を指定し、**[確認および作成]** を選択します。

    |設定|値|
    |---|---|
    |サブスクリプション|このラボで使用している Azure サブスクリプションの名前|
    |リソース グループ|新しいリソース グループの名前 **az140-411e-RG**|
    |Name|**az140-laworkspace41e**|
    |リージョン|Azure Virtual Desktop 環境をデプロイした Azure リージョンの名前|

1. **[確認および作成]** ページで、 **[作成]** を選択します。

    > **注**:プロビジョニング プロセスが完了するまで待ちます。 通常、これには 1 分ほどかかります。

    > **注**: 次に、Azure Virtual Desktop 環境の診断、セッション ホストのパフォーマンス カウンター、Azure Virtual Desktop セッション ホストの Windows イベント ログの新しくプロビジョニングされた Log Analytics ワークスペースでデータ収集を有効にする必要があります。

#### タスク 3: Virtual Desktop Insights 構成ブックを設定する

> **注**: Azure Virtual Desktop Insights を初めて開く場合は、お使いの Azure Virtual Desktop 環境用に Azure Virtual Desktop Insights をセットアップする必要があります。

1. ラボ コンピューターの Azure portal が表示されている Web ブラウザーで、**Azure Virtual Desktop** を検索して選択し、**[Azure Virtual Desktop]** ページの縦型ナビゲーション メニューで、**[監視]** セクションの **[ブック]** を選択します。
1. **Windows Virtual Desktop** ブックの一覧の **[Windows Virtual Desktop]** セクションで、**Insights** ブックを選択します。
1. **[Azure Virtual Desktop \| ブック \| Insights]** ページで、ワークスペース ホストとセッション ホストがワークスペースにデータを送信しないことを示す警告メッセージを確認したあと、**[構成ブック]** リンクを選択して問題を修復します。
1. **[CheckAMAConfiguration]** ページの **[リソース診断設定]** タブで、**[Log Analytics ワークスペース]** ドロップダウンリストから **[az140-laworkspace41e]** を選択します。
1. **[CheckAMAConfiguration]** ページの **[リソース診断設定]** タブの **[ホスト プール az140-21-hp1]** セクションで、選択したホスト プールの既存の診断構成が見つからなかったことを示す警告メッセージに注意して、**[ホスト プールの構成]** を選択します。
1. **[テンプレートのデプロイ]** ペインで **[デプロイ]** を選択します。

    > **注**: これにより、ターゲット Log Analytics ワークスペースで次の診断テーブルが効果的に有効になります。
    - 管理アクティビティ
    - フィード
    - 接続
    - エラー
    - チェックポイント
    - HostRegistration
    - AgentHealthStatus 

    > **注**: デプロイが完了するまで待ちます。 通常、所要時間は 1 分以下です。

1. **[CheckAMAConfiguration]** ページの **[リソース診断設定]** タブで、ツール バーの**更新**アイコン (円形の矢印) を選択します。
1. **[ホスト プール az140-21-hp1]** セクションをレビューし、**[allLogs]** の診断設定が有効になっていることを確認します。
1. **[リソース診断設定]** タブで、**[ワークスペース az140-21-ws1]** セクションまで下にスクロールし、**[ワークスペースの構成]** を選択します。
1. **[テンプレートのデプロイ]** ペインで **[デプロイ]** を選択します。

    > **注**: これにより、**[allLogs]** のワークスペースが効果的に構成されます。

    > **注**: デプロイが完了するまで待ちます。 通常、所要時間は 1 分以下です。

1. **[CheckAMAConfiguration]** ページの **[リソース診断設定]** タブで、ツール バーの**更新**アイコン (円形の矢印) を選択します。
1. **[ワークスペース az140-21-ws1]** セクションをレビューし、**[allLogs]** の診断設定が有効になっており、残りの警告メッセージがないことを確認します。
1. **[CheckAMAConfiguration]** ページの上部に移動し、**[ホスト データ設定の選択]** タブに切り替えます。
1. **[ホスト データ設定の選択]** タブの **[DCR の作成]** セクションで、**[ワークスペースの宛先]** ドロップダウン リストから **az140-laworkspace41e** を選択し、**[データ収集ルールの作成]** を選択します。
1. **[テンプレートのデプロイ]** ペインで **[デプロイ]** を選択します。

    > **注**: デプロイが完了するまで待ちます。 通常、所要時間は 1 分以下です。

1. **[CheckAMAConfiguration]** ページの **[ホスト データ設定の選択]** タブで、ツール バーの **[更新]** アイコン (円形の矢印) を選択します。

    > **注**: 先に進む前に、新しく作成した DCR が **[DCR の作成]** セクションの **[使用可能な DCR]** サブセクションに表示されていることを確認してください。 そうでない場合は、もう 1 分間待ってから、ページをもう一度更新します。

1. **[ホスト データ設定の選択]** タブの **[選択した DCR]** ドロップダウン リストで、**microsoft-avdi-** プレフィックスで始まるエントリを選択します。
1. **[ホスト データ設定の選択]** タブの **[DCR の関連付け]** セクションで、**[関連付けのデプロイ]** を選択します。
1. **[テンプレートのデプロイ]** ペインで **[デプロイ]** を選択します。

    > **注**: これにより、新しく作成した DCR が、**az140-21-hp1** ホスト プール内のセッション ホストに効果的に関連付けられます。

    > **注**: デプロイが完了するまで待ちます。 通常、所要時間は 1 分以下です。

1. **[CheckAMAConfiguration]** ページの **[ホスト データ設定の選択]** タブで、ツール バーの **[更新]** アイコン (円形の矢印) を選択します。
1. **[ホスト データ設定の選択]** タブの **[Azure Monitor 拡張機能がないセッション ホスト]** セクションで、**[拡張機能の追加]** を選択します。
1. **[テンプレートのデプロイ]** ペインで **[デプロイ]** を選択します。

    > **注**: これにより、**az140-21-hp1** ホスト プール内のセッション ホストに Azure Monitor 拡張機能が効果的にインストールされます。

    > **注**: デプロイが完了するまで待ちます。 これには 1 分ほどかかる場合があります。

1. **[CheckAMAConfiguration]** ページの **[ホスト データ設定の選択]** タブで、ツール バーの **[更新]** アイコン (円形の矢印) を選択します。
1. エラー メッセージまたは警告メッセージが表示されていないことを確認します。 
1. **[CheckAMAConfiguration]** ページの上部に移動し、**[生成されたデータ]** タブを選択してから、ツール バーの **[更新]** アイコン (円形の矢印) を選択します。
1. 収集されたデータを表すグラフを表示するセクションを確認します。これには、**過去 24 時間の課金データ**、**パフォーマンス カウンター**、**イベント**が含まれます。

    > **注**: データ インジェストを監視するには、**過去 24 時間の課金データ**を使用します。 データ ストレージとインジェストに対する Log Analytics の料金はユーザーが負担します。

1. Azure portal が表示されている Web ブラウザーで、**[Azure Virtual Desktop]** ページに戻り、垂直ナビゲーション メニューの **[監視]** セクションで、**[分析情報]** を選択します。
1. **[Azure Virtual Desktop \| の分析情報]** ページで、**[最大利用可能時間]** セクション、**接続の診断: 接続できるユーザーの割合**、**接続のパフォーマンス: 接続時間 (新しいセッション)**、**稼働率**テレメトリなどを含む **[概要]** タブの内容を確認します。 
1. 次に、**[Azure Virtual Desktop \| の分析情報]** ページの残りのすべてのタブ (**接続の信頼性**、**接続の診断**、**接続のパフォーマンス**、**ユーザー**、**稼働率**、**クライアント**、**アラート**など) を確認します。

    > **注**: 後続のラボを完了して収集されたテレメトリを表すグラフを確認したら、分析情報ページのこれらのタブを再確認することを検討してください。
